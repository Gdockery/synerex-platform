<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xeco Final Truth</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
        form { max-width: 420px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        label { display: block; margin: 12px 0 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-top: 15px; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; }
        .segment { margin: 10px 0; padding: 10px; background: #e9f7ff; border-left: 4px solid #007bff; border-radius: 4px; }
        .summary { font-weight: bold; margin: 12px 0; padding: 10px; background: #d4edda; border-radius: 4px; }
        .consolidation { background: #fff3cd; padding: 8px; border-radius: 4px; margin: 5px 0; font-style: italic; }
        .warning { color: #d39e00; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Xeco Final Recommendation</h2>
    <p><strong>600 preferred unless THD >40%. Harmonics do NOT split. 200A = 2×100A segments.</strong></p>
    
    <form id="calcForm">
        <label for="amps">Load Current (A):</label>
        <input type="number" id="amps" value="200" required>

        <label for="pf">Power Factor (%):</label>
        <input type="number" id="pf" min="0" max="100" value="70" required>

        <label for="h3">3rd Harmonic (A):</label>
        <input type="number" id="h3" value="13.25" min="0" required>

        <label for="h5">5th Harmonic (A):</label>
        <input type="number" id="h5" value="13.25" min="0" required>

        <label for="h7">7th Harmonic (A):</label>
        <input type="number" id="h7" value="13.25" min="0" required>

        <label for="h11">11th Harmonic (A):</label>
        <input type="number" id="h11" value="13.25" min="0" required>

        <label><input type="checkbox" id="vfd"> VFD Present?</label>

        <button type="button" onclick="calculate()">Calculate</button>
    </form>

    <div id="result"></div>

    <script>
        function calculate() {
            const amps = parseFloat(document.getElementById('amps').value);
            const pf = parseFloat(document.getElementById('pf').value);
            const h3 = parseFloat(document.getElementById('h3').value);
            const h5 = parseFloat(document.getElementById('h5').value);
            const h7 = parseFloat(document.getElementById('h7').value);
            const h11 = parseFloat(document.getElementById('h11').value);
            const vfd = document.getElementById('vfd').checked;

            const totalHarm = Math.sqrt(h3**2 + h5**2 + h7**2 + h11**2);
            const thd = (totalHarm / amps) * 100;
            const segments = Math.ceil(amps / 100);
            
	    let html = '';
            let equip = [];

            if (amps < 30) {
                html += `<div class="segment">Under 30A: Move upstream. No install.</div>`;
            } else {
                html += `<strong>${amps}A → ${segments} × 100A segments</strong><br>`;

                for (let i = 0; i < segments; i++) {
                    const rec = get100ARecommendation(totalHarm/segments, pf, vfd);
                    html += `<div class="segment">100A: ${rec.text}</div>`;
                    equip.push(...rec.equip);
                }
            }

            // === CONSOLIDATION: 2× APF-50 → 1× APF-100 ===
            let apf50 = equip.filter(x => x === 'APF-50').length;
            let apf100 = equip.filter(x => x === 'APF-100').length;
            let unit600 = equip.filter(x => x === '600').length;

            const pairs = Math.floor(apf50 / 2);
            if (pairs > 0) {
                apf50 -= pairs * 2;
                apf100 += pairs;
                html += `<div class="consolidation">${pairs}× (2× APF-50 → 1× APF-100)</div>`;
            }
	    if (segments > 0 && totalHarm/segments < 20) {
		if (totalHarm > 50) {
		  apf100+=1;
		} else {
		  apf50+=1;
		}
	    }
	    if (amps > 100) {
	    	unit600 += Math.ceil((amps/100)) -1;
	    }

            // === FINAL ===
            if (apf100 + apf50 + unit600 === 0) {
                html += `<div class="summary warning">No install unless ROI justifies.</div>`;
            } else {
                html += `<div class="summary">Final: ${apf100}× APF-100, ${apf50}× APF-50, ${unit600}× 600</div>`;
            }

            html += `<br><em>Harmonics: ${totalHarm.toFixed(1)}A | THD: ${thd.toFixed(1)}% | PF: ${pf}%</em>`;
            document.getElementById('result').innerHTML = html;
        }

        function get100ARecommendation(totalHarm, pf, vfd) {
            const rec = { text: '', equip: [] };

            if (totalHarm > 40) {
                if (pf < 80) {
                    rec.text = 'Harmonics >40A, PF <80 → APF-100 + 600';
                    rec.equip = ['APF-100', '600'];
                } else if (pf < 90) {
                    rec.text = 'Harmonics >40A, PF 80–90 → APF-50';
                    rec.equip = ['APF-50'];
                } else {
                    rec.text = 'Harmonics >40A, PF >90 → APF-50';
                    rec.equip = ['APF-50'];
                }
            } else if (totalHarm > 20) {
                if (pf > 75 && pf < 85) {
                    rec.text = 'Harmonics 20–40A, PF 75–85 → APF-50';
                    rec.equip = ['APF-50'];
                } else if (pf <= 75) {
                    rec.text = 'Harmonics 20–40A, PF ≤75 → APF-50 + 600';
                    rec.equip = ['APF-50', '600'];
                } else if (vfd && pf < 70) {
                    rec.text = 'VFD + PF <70 → APF-100';
                    rec.equip = ['APF-100'];
                } else if (vfd && pf < 85) {
                    rec.text = 'VFD + PF <85 → APF-50';
                    rec.equip = ['APF-50'];
                } else {
                    rec.text = 'Harmonics 20–40A → APF-50';
                    rec.equip = ['APF-50'];
                }
            } else if (totalHarm <= 20 && pf < 85 && !vfd) {
                rec.text = 'Harmonics ≤20A, PF <85, no VFD → 600';
                rec.equip = ['600'];
            } else {
                rec.text = 'No strong trigger. ROI required.';
            }
            return rec;
        }
    </script>
</body>
</html>
