<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Synerex - CSV Tamper-Proofing Utility-Grade Audit System (Updated 19:35)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main_dashboard.css') }}?v={{ cache_bust }}">
    <link rel="icon" href="{{ url_for('static', filename='synerex_logo_transparent.png') }}" type="image/png">
</head>
<body>
    <!-- Main Dashboard Container -->
    <div id="main-dashboard" class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-left">
                <img src="{{ url_for('static', filename='synerex_logo_transparent.png') }}?v={{ cache_bust }}&t={{ cache_bust }}" alt="Synerex" class="logo">
                <h1>CSV Tamper-Proofing Utility-Grade Audit System</h1>
                <!-- Template updated: 2025-10-05 22:30 - Logo changed to transparent version -->
            </div>
            <div class="header-right">
                <div class="header-buttons-left">
                    <button id="help-btn" class="btn-help">Help</button>
                    <button id="users-guide-btn" class="btn-users-guide" onclick="window.open('/users-guide', '_blank')">User's Guide</button>
                    <button id="csv-editor-guide-btn" class="btn-users-guide" onclick="window.open('/csv-editor-guide', '_blank')" title="CSV Editor Guide">üìñ CSV Guide</button>
                    <button id="standards-guide-btn" class="btn-standards-guide" onclick="window.open('/standards-guide', '_blank')">Standards Guide</button>
                    <button id="synerex-ai-btn" class="btn-synerex-ai" onclick="window.open('/synerex-ai', '_blank')">SynerexAI</button>
                    <button id="admin-btn" class="btn-admin" onclick="openAdminPanel()" style="display: none;">Admin</button>
                </div>
                <div class="header-buttons-right">
                    <button id="synerex-ai-chat-btn" class="btn-synerex-ai-chat" onclick="toggleSynerexAIChat()">Ask SynerexAI</button>
                    <div id="user-info" class="user-info" style="display: none;">
                        <span id="current-user-name">Welcome, User</span>
                        <button id="logout-btn" class="btn-logout">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SynerexAI Chat Dropdown Widget -->
        <div id="synerex-ai-chat-widget" class="synerex-ai-chat-widget" style="display: none;">
            <div class="chat-widget-header">
                <div class="chat-widget-title">
                    <img src="{{ url_for('static', filename='synerex_logo_transparent.png') }}?v={{ cache_bust }}" alt="SYNEREX" class="chat-logo">
                    <span class="ai-suffix">AI</span>
                    <span class="chat-title">SynerexAI Assistant</span>
                </div>
                <button class="chat-close-btn" onclick="toggleSynerexAIChat()">√ó</button>
            </div>
            
            <div class="chat-widget-content">
                <div class="chat-messages" id="chatMessages">
                    <div class="ai-message">
                        <strong>SynerexAI:</strong> Hello! I'm your specialized Energy AI assistant. I can help with energy analysis, XECO equipment, utility information, electrical code guidance, and installation assistance. What energy-related question can I help you with?
                    </div>
                </div>
                
                <div class="example-questions">
                    <h4>üí° Quick Questions:</h4>
                    <div class="question-chips">
                        <span class="question-chip" onclick="askQuickQuestion('What are XECO-HF Series specifications?')">XECO-HF Specs</span>
                        <span class="question-chip" onclick="askQuickQuestion('How to install XECO-PFC?')">XECO-PFC Install</span>
                        <span class="question-chip" onclick="askQuickQuestion('What are the utility rates here?')">Utility Rates</span>
                        <span class="question-chip" onclick="askQuickQuestion('Help with electrical code compliance')">Electrical Code</span>
                        <span class="question-chip" onclick="askQuickQuestion('How do I use the SYNEREX dashboard?')">SYNEREX Help</span>
                        <span class="question-chip" onclick="askQuickQuestion('How do I upload CSV files?')">CSV Upload</span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Ask SynerexAI about energy analysis, XECO equipment, utility rates..." onkeypress="handleChatKeyPress(event)">
                    <button class="chat-send-btn" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="dashboard-content">
            <!-- Login Section (shown when not authenticated) -->
            <div id="login-section" class="dashboard-section">
                <div class="section-header">
                    <h2>User Authentication</h2>
                    <p>Please login to access the CSV Tamper-Proofing Utility-Grade Audit System</p>
                </div>
                <div class="section-content">
                    <div class="login-forms">
                        <div class="login-form">
                            <h3>Login</h3>
                            <form id="user-login">
                                <div class="form-group">
                                    <label>Username/Email:</label>
                                    <input type="text" id="username" required>
                                </div>
                                <div class="form-group">
                                    <label>Password:</label>
                                    <div class="password-input-container">
                                        <input type="password" id="password" required>
                                        <button type="button" class="password-toggle" id="toggle-login-password" onclick="togglePasswordVisibility('password', 'toggle-login-password')">
                                            <span class="eye-icon">Show</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Role:</label>
                                    <select id="user-role" required>
                                        <option value="">Select Role</option>
                                        <option value="pe">Professional Engineer (PE)</option>
                                        <option value="engineer">Engineer</option>
                                        <option value="technician">Technician</option>
                                        <option value="administrator">System Administrator</option>
                                        <option value="auditor">Auditor</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary">Login</button>
                            </form>
                        </div>
                        
                        <div class="register-form">
                            <h3>Register New User</h3>
                            <form id="user-registration">
                                <div class="form-group">
                                    <label>Full Name:</label>
                                    <input type="text" id="full-name" required>
                                </div>
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="email" required>
                                </div>
                                <div class="form-group">
                                    <label>Username:</label>
                                    <input type="text" id="reg-username" required>
                                </div>
                                <div class="form-group">
                                    <label>Password:</label>
                                    <div class="password-input-container">
                                        <input type="password" id="reg-password" required placeholder="Minimum 8 characters with numbers and symbols">
                                        <button type="button" class="password-toggle" id="toggle-password" onclick="togglePasswordVisibility('reg-password', 'toggle-password')">
                                            <span class="eye-icon">Show</span>
                                        </button>
                                    </div>
                                    <div class="password-strength">
                                        <div id="password-strength-bar" class="password-strength-bar"></div>
                                    </div>
                                    <div id="password-strength-message" class="password-feedback" style="display: none;"></div>
                                    <div class="password-requirements">
                                        <small>Password must contain:</small>
                                        <ul>
                                            <li id="req-length">At least 8 characters</li>
                                            <li id="req-uppercase">One uppercase letter</li>
                                            <li id="req-lowercase">One lowercase letter</li>
                                            <li id="req-number">One number</li>
                                            <li id="req-special">One special character</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password:</label>
                                    <div class="password-input-container">
                                        <input type="password" id="reg-confirm-password" required placeholder="Re-enter your password">
                                        <button type="button" class="password-toggle" id="toggle-confirm-password" onclick="togglePasswordVisibility('reg-confirm-password', 'toggle-confirm-password')">
                                            <span class="eye-icon">Show</span>
                                        </button>
                                    </div>
                                    <div id="password-match-message" class="password-feedback" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Role:</label>
                                    <select id="reg-user-role" required>
                                        <option value="">Select Role</option>
                                        <option value="pe">Professional Engineer (PE)</option>
                                        <option value="engineer">Engineer</option>
                                        <option value="technician">Technician</option>
                                        <option value="administrator">System Administrator</option>
                                        <option value="auditor">Auditor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>PE License Number (if applicable):</label>
                                    <input type="text" id="pe-license" placeholder="e.g., PE12345-CA">
                                </div>
                                <div class="form-group">
                                    <label>State/Province:</label>
                                    <input type="text" id="state" placeholder="e.g., CA, TX, NY">
                                </div>
                                <button type="submit" class="btn-primary">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Dashboard (shown when authenticated) -->
            <div id="main-sections" class="dashboard-sections" style="display: none;">
                <!-- Raw Meter File Storage -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Raw Meter File Storage</h2>
                        <p>Upload and manage raw CSV files from meters</p>
                    </div>
                    <div class="section-content">
                        <div class="section-actions">
                            <button id="upload-raw-data" class="btn-primary">Upload Raw Data</button>
                            <button id="view-raw-files" class="btn-secondary">View Raw Files</button>
                            <button id="raw-data-stats" class="btn-info">Statistics</button>
                        </div>
                        <div class="section-stats">
                            <div class="stat-card">
                                <h3 id="raw-files-count">0</h3>
                                <p>Raw Files</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="raw-files-size">0 MB</h3>
                                <p>Total Size</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="raw-files-recent">0</h3>
                                <p>Recent Uploads</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CSV File Review -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>CSV File Review & Verification</h2>
                        <p>Review files for integrity and perform clipping operations</p>
                    </div>
                    <div class="section-content">
                        <div class="section-actions">
                            <button id="start-clipping" class="btn-primary">Start Clipping</button>
                            <button id="view-fingerprints" class="btn-secondary">View Fingerprints</button>
                            <button id="verify-integrity" class="btn-info">Verify Integrity</button>
                        </div>
                        <div class="section-stats">
                            <div class="stat-card">
                                <h3 id="clipped-files-count">0</h3>
                                <p>Clipped Files</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="modifications-count">0</h3>
                                <p>Modifications</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="integrity-status">100%</h3>
                                <p>Integrity Status</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Project Management -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>Project Management</h2>
                        <p>Create new projects or access existing ones</p>
                    </div>
                    <div class="section-content">
                        <div class="section-actions">
                            <button id="create-project" class="btn-primary">‚ûï Create New Project</button>
                            <button id="access-project" class="btn-secondary">üìÇ Access Project</button>
                            <button id="project-templates" class="btn-info">üìÑ Templates</button>
                        </div>
                        <div class="section-stats">
                            <div class="stat-card">
                                <h3 id="active-projects-count">0</h3>
                                <p>Active Projects</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="completed-projects-count">0</h3>
                                <p>Completed</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="project-files-count">0</h3>
                                <p>Project Files</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Facility-Specific Analysis -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h2>üè≠ Facility-Specific Analysis</h2>
                        <p>Choose the analysis interface optimized for your facility type</p>
                    </div>
                    <div class="section-content">
                        <div class="facility-type-grid">
                            <div class="facility-card" onclick="window.location.href='/legacy'">
                                <div class="facility-icon">Settings</div>
                                <h3>General Energy Analysis</h3>
                                <p>Standard power quality and energy analysis</p>
                                <ul class="facility-features">
                                    <li>Power quality metrics</li>
                                    <li>Harmonic analysis</li>
                                    <li>Network losses</li>
                                    <li>Demand reduction</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> General industrial facilities, facilities without specific facility type
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                            <div class="facility-card" onclick="window.location.href='/cold-storage'">
                                <div class="facility-icon">‚ùÑÔ∏è</div>
                                <h3>Cold Storage Facility</h3>
                                <p>Energy intensity per unit of product</p>
                                <ul class="facility-features">
                                    <li>kWh per pound/ton</li>
                                    <li>Product-based savings</li>
                                    <li>Storage efficiency metrics</li>
                                    <li>Contents-based reporting</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> Cold storage warehouses, food processing facilities, distribution centers, refrigerated transportation
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                            <div class="facility-card" onclick="window.location.href='/data-center'">
                                <div class="facility-icon">üñ•Ô∏è</div>
                                <h3>Data Center / GPU Facility</h3>
                                <p>PUE, ITE, and compute efficiency</p>
                                <ul class="facility-features">
                                    <li>Power Usage Effectiveness (PUE)</li>
                                    <li>GPU efficiency metrics</li>
                                    <li>Cooling efficiency</li>
                                    <li>Compute intensity</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> Traditional data centers, GPU/AI training facilities, colocation facilities, edge computing centers, hybrid cloud facilities
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                            <div class="facility-card" onclick="window.location.href='/healthcare'">
                                <div class="facility-icon">üè•</div>
                                <h3>Healthcare Facilities</h3>
                                <p>Energy per patient day and critical power analysis</p>
                                <ul class="facility-features">
                                    <li>kWh per patient-day</li>
                                    <li>Energy per bed (kWh/bed/year)</li>
                                    <li>Energy Use Intensity (EUI)</li>
                                    <li>Medical equipment efficiency</li>
                                    <li>Critical power redundancy</li>
                                    <li>24/7 operation analysis</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> Hospitals, clinics, medical centers, surgical centers, urgent care facilities, nursing homes
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                            <div class="facility-card" onclick="window.location.href='/hospitality'">
                                <div class="facility-icon">Hotel</div>
                                <h3>Hospitality Facilities</h3>
                                <p>Energy per room-night, guest, and meal analysis</p>
                                <ul class="facility-features">
                                    <li>kWh per occupied room-night</li>
                                    <li>kWh per guest</li>
                                    <li>kWh per meal (restaurants)</li>
                                    <li>Kitchen energy intensity</li>
                                    <li>Laundry efficiency</li>
                                    <li>Occupancy normalization</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> Hotels, resorts, restaurants, banquet halls, casinos
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                            <div class="facility-card" onclick="window.location.href='/manufacturing'">
                                <div class="facility-icon">üè≠</div>
                                <h3>Manufacturing & Industrial</h3>
                                <p>Energy per unit produced and process efficiency</p>
                                <ul class="facility-features">
                                    <li>kWh per unit produced</li>
                                    <li>kWh per machine hour</li>
                                    <li>Compressed air efficiency</li>
                                    <li>Motor efficiency metrics</li>
                                    <li>Production efficiency index</li>
                                    <li>Equipment utilization</li>
                                </ul>
                                <div class="industries-covered">
                                    <strong>Industries:</strong> Manufacturing plants, assembly plants, processing facilities, foundries, chemical processing, food processing, textile manufacturing, automotive, electronics, pharmaceutical, paper/pulp processing
                                </div>
                                <button class="facility-btn">Start Analysis ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PE Management -->
                <div class="dashboard-section" id="pe-section" style="display: none;">
                    <div class="section-header">
                        <h2>Professional Engineer Management</h2>
                        <p>Register and manage PE certifications</p>
                    </div>
                    <div class="section-content">
                        <div class="section-actions">
                            <button id="register-pe" class="btn-primary">Register New PE</button>
                            <button id="pe-dashboard" class="btn-secondary">PE Dashboard</button>
                            <button id="verify-licenses" class="btn-info">Verify Licenses</button>
                        </div>
                        <div class="section-stats">
                            <div class="stat-card">
                                <h3 id="registered-pe-count">0</h3>
                                <p>Registered PEs</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="active-pe-count">0</h3>
                                <p>Active PEs</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="pe-oversight-level">0%</h3>
                                <p>Oversight Level</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" id="system-status">System Status</a>
                    <a href="#" id="audit-compliance">Audit Compliance</a>
                    <a href="#" id="documentation">Documentation</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Help System -->
    <div id="help-system" class="help-panel" style="display: none;">
        <div class="help-header">
            <h3>User Guide</h3>
            <button id="close-help" class="btn-close">√ó</button>
        </div>
        <div class="help-content">
            <div class="help-step active" data-step="1">
                <h4>Step 1: Login or Register</h4>
                <p>Use the login form to access the system or register a new account with appropriate role permissions.</p>
            </div>
            <div class="help-step" data-step="2">
                <h4>Step 2: Upload Raw Data</h4>
                <p>Upload raw CSV files from meters to the system for processing and analysis.</p>
            </div>
            <div class="help-step" data-step="3">
                <h4>Step 3: Review and Clip Data</h4>
                <p>Review uploaded files for integrity and perform clipping operations if needed.</p>
            </div>
            <div class="help-step" data-step="4">
                <h4>Step 4: Create Projects</h4>
                <p>Create new projects or access existing ones to begin analysis.</p>
            </div>
            <div class="help-step" data-step="5">
                <h4>Step 5: PE Oversight (if applicable)</h4>
                <p>Professional Engineers can register and provide oversight for projects.</p>
            </div>
        </div>
        <div class="help-navigation">
            <button id="prev-step" class="btn-secondary">Previous</button>
            <button id="next-step" class="btn-primary">Next</button>
        </div>
    </div>

    <!-- Notification Banner -->
    <div id="notification-banner" class="notification-banner" style="display: none;">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button id="notification-close" class="btn-close">√ó</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        console.log('HTML template loaded, about to load main_dashboard.js');
        console.log('Cache bust value:', '{{ cache_bust }}');
        
        // Check for license token in URL and auto-login
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                console.log('License token detected in URL, attempting auto-login...');
                
                // Attempt login with license token
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        license_token: token
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('License login successful');
                        // Store session token
                        localStorage.setItem('session_token', data.session_token);
                        
                        // Store license info if provided
                        if (data.license_id) {
                            localStorage.setItem('license_id', data.license_id);
                        }
                        if (data.org_id) {
                            localStorage.setItem('org_id', data.org_id);
                        }
                        
                        // Remove token from URL and reload
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        
                        // Trigger page reload or redirect to dashboard
                        window.location.reload();
                    } else {
                        console.error('License login failed:', data.error);
                        alert('License validation failed: ' + data.error);
                        // Remove token from URL
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    }
                })
                .catch(error => {
                    console.error('Error during license login:', error);
                    alert('Unable to validate license. Please try again.');
                    // Remove token from URL
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                });
            }
        })();
    </script>
    <script src="{{ url_for('static', filename='main_dashboard.js') }}?v={{ cache_bust }}"></script>
    <script src="{{ url_for('static', filename='ollama_ai_service.js') }}?v={{ cache_bust }}"></script>
    <script src="{{ url_for('static', filename='javascript_functions.js') }}?v={{ cache_bust }}"></script>
    <script>
        console.log('main_dashboard.js script tag loaded');
        console.log('ollama_ai_service.js script tag loaded');
    </script>
</body>
</html>
